<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeBotPro - Complete Your Purchase</title>
    
    <!-- Tailwind CSS -->
    <link href="/dist/output.css" rel="stylesheet">
    
    <style>
        /* Critical CSS */
        :root {
            --primary-color: #2563eb;
            --success-color: #059669;
            --error-color: #dc2626;
        }

        body {
            background-color: #111827;
            color: #ffffff;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .hidden {
            display: none;
        }

        .payment-container {
            background-color: #1f2937;
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .payment-error {
            display: none;
            background-color: var(--error-color);
            color: white;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 1rem;
        }
        
        .payment-success {
            display: none;
            background-color: var(--success-color);
            color: white;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 1rem;
        }

        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.5);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 50;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Product Details */
        .product-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .product-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .product-info {
            font-size: 1.25rem;
            color: #9ca3af;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: bold;
            color: #34d399;
            margin: 0.5rem 0;
        }

        /* PayPal Button Container */
        #paypal-button-container {
            margin-top: 2rem;
        }

        /* Features List */
        .features-list {
            margin: 2rem 0;
            padding: 0;
            list-style: none;
        }

        .features-list li {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .features-list li::before {
            content: "âœ“";
            color: var(--success-color);
            position: absolute;
            left: 0;
        }

        /* Responsive Design */
        @media (max-width: 640px) {
            .payment-container {
                padding: 1rem;
            }

            .product-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="min-h-screen py-8">
        <div class="container mx-auto px-4">
            <main class="max-w-2xl mx-auto">
                <!-- Product Information -->
                <div class="product-header">
                    <h1 class="product-title">Complete Your Purchase</h1>
                    <div id="product-info" class="product-info"></div>
                    <div id="price-display" class="product-price"></div>
                </div>

                <!-- Payment Container -->
                <div class="payment-container">
                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <span class="ml-3">Processing your payment...</span>
                    </div>

                    <!-- Features List -->
                    <ul class="features-list" id="features-list">
                        <!-- Features will be populated by JavaScript -->
                    </ul>

                    <!-- PayPal Buttons -->
                    <div id="paypal-button-container"></div>

                    <!-- Error Message -->
                    <div id="purchase-error" class="payment-error">
                        <strong>Error:</strong>
                        <span id="error-message"></span>
                    </div>

                    <!-- Success Message -->
                    <div id="payment-success" class="payment-success">
                        <strong>Success!</strong>
                        <p>Your purchase has been completed. You will receive an email with your license key and download instructions.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AbFAFD99aa0hCnoggRAkKPvSg7i-FBwF1jQvHIqRwIxhgN4nh6fXk_-hxClQj0hCgvbH7m8vT6d2sPHi&currency=USD"></script>
    
    <!-- App Logic -->
    <script>
        // Product Configuration
        const PRODUCTS = {
            'lite': {
                name: 'TradeBotPro Lite Version',
                price: '49.99',
                productType: 'digital_goods',
                features: [
                    'Basic trading algorithms',
                    'Market data analysis',
                    'Real-time notifications',
                    'Single exchange support',
                    '24/7 email support'
                ]
            },
            'full': {
                name: 'TradeBotPro Pro Version',
                price: '199.99',
                productType: 'digital_goods',
                features: [
                    'Advanced trading algorithms',
                    'AI-powered market analysis',
                    'Multi-exchange support',
                    'Priority 24/7 support',
                    'Custom strategy builder',
                    'Portfolio management',
                    'Risk management tools',
                    'API access'
                ]
            }
        };

        // Initialize PayPal buttons
        paypal.Buttons({
            style: {
                layout: 'vertical',
                color: 'gold',
                shape: 'rect',
                label: 'pay'
            },

            createOrder: async function(data, actions) {
                try {
                    // Show loading state
                    document.getElementById('loading').style.display = 'flex';
                    
                    // Get version from URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const version = urlParams.get('version');
                    
                    if (!version || !PRODUCTS[version]) {
                        throw new Error('Invalid version parameter');
                    }

                    const product = PRODUCTS[version];

                    // Create order with backend
                    const response = await fetch('https://tradebotpro-backend-553116950013.us-central1.run.app/api/create-paypal-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            version: version,
                            productType: product.productType,
                            name: product.name,
                            price: parseFloat(product.price),
                            currency: 'USD'
                        })
                    });

                    if (!response.ok) {
                        let errorMessage = 'Failed to create order';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorData.message || errorMessage;
                        } catch (parseError) {
                            console.warn('Could not parse error response:', parseError);
                            errorMessage = `Server error (${response.status}): ${response.statusText}`;
                        }
                        throw new Error(errorMessage);
                    }

                    const orderData = await response.json();
                    
                    if (!orderData.orderID) {
                        throw new Error('Invalid response from server: missing order ID');
                    }
                    
                    return orderData.orderID;
                } catch (err) {
                    console.error('Order creation failed:', err);
                    
                    // Show error message to user
                    const errorElement = document.getElementById('purchase-error');
                    const errorMessageElement = document.getElementById('error-message');
                    
                    errorElement.style.display = 'block';
                    errorElement.classList.remove('hidden');
                    
                    // Provide user-friendly error messages
                    if (err.message.includes('network') || err.message.includes('fetch')) {
                        errorMessageElement.textContent = 'Network error. Please check your connection and try again.';
                    } else if (err.message.includes('Invalid version')) {
                        errorMessageElement.textContent = 'Invalid product selection. Please go back and try again.';
                    } else {
                        errorMessageElement.textContent = err.message || 'An unexpected error occurred. Please try again.';
                    }
                    
                    throw err;
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            },

            onApprove: async function(data, actions) {
                try {
                    document.getElementById('loading').style.display = 'flex';
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const version = urlParams.get('version');
                    
                    if (!version || !PRODUCTS[version]) {
                        throw new Error('Invalid product version');
                    }
                    
                    const response = await fetch('https://tradebotpro-backend-553116950013.us-central1.run.app/api/capture-paypal-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            orderID: data.orderID,
                            version: version,
                            paymentID: data.paymentID || null,
                            payerID: data.payerID || null
                        })
                    });

                    if (!response.ok) {
                        let errorMessage = 'Payment capture failed';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorData.message || errorMessage;
                        } catch (parseError) {
                            console.warn('Could not parse error response:', parseError);
                            errorMessage = `Server error (${response.status}): ${response.statusText}`;
                        }
                        throw new Error(errorMessage);
                    }

                    const captureData = await response.json();
                    
                    // Validate response data
                    if (!captureData || typeof captureData !== 'object') {
                        throw new Error('Invalid response from server');
                    }
                    
                    // Store success data with additional info for success page
                    sessionStorage.setItem('tradebotpro_purchase', JSON.stringify({
                        orderID: data.orderID,
                        downloadUrl: captureData.downloadUrl || null,
                        licenseKey: captureData.licenseKey || null,
                        version: version,
                        productName: PRODUCTS[version].name
                    }));

                    // Also store individual items for backward compatibility
                    if (captureData.downloadUrl) {
                        sessionStorage.setItem('tradebotpro_download_url', captureData.downloadUrl);
                    }
                    if (captureData.licenseKey) {
                        sessionStorage.setItem('tradebotpro_license_key', captureData.licenseKey);
                    }
                    sessionStorage.setItem('tradebotpro_product_type', version);

                    // Show success message briefly before redirect
                    document.getElementById('payment-success').style.display = 'block';
                    setTimeout(() => {
                        window.location.href = '/success.html';
                    }, 2000);

                } catch (err) {
                    console.error('Payment capture failed:', err);
                    
                    // Show error message to user
                    const errorElement = document.getElementById('purchase-error');
                    const errorMessageElement = document.getElementById('error-message');
                    
                    errorElement.style.display = 'block';
                    errorElement.classList.remove('hidden');
                    
                    // Provide user-friendly error messages
                    if (err.message.includes('network') || err.message.includes('fetch')) {
                        errorMessageElement.textContent = 'Network error during payment processing. Please contact support if the payment was charged.';
                    } else if (err.message.includes('Invalid product version')) {
                        errorMessageElement.textContent = 'Invalid product selection. Please go back and try again.';
                    } else {
                        errorMessageElement.textContent = err.message || 'Payment processing failed. Please try again.';
                    }
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            },

            onCancel: function(data) {
                // Log cancellation for analytics if needed
                console.log('Payment cancelled by user');
                
                // Redirect to cancel page
                window.location.href = '/cancel.html';
            },

            onError: function(err) {
                console.error('PayPal error:', err);
                
                // Show error message to user
                const errorElement = document.getElementById('purchase-error');
                const errorMessageElement = document.getElementById('error-message');
                
                errorElement.style.display = 'block';
                errorElement.classList.remove('hidden');
                
                // Provide user-friendly error message
                errorMessageElement.textContent = 'PayPal payment processing failed. Please try again or use a different payment method.';
                
                // Hide loading indicator if shown
                document.getElementById('loading').style.display = 'none';
            }
        }).render('#paypal-button-container');

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const version = urlParams.get('version');
            
            if (version && PRODUCTS[version]) {
                const product = PRODUCTS[version];
                
                // Safely update DOM elements
                const productInfoElement = document.getElementById('product-info');
                const priceDisplayElement = document.getElementById('price-display');
                const featuresListElement = document.getElementById('features-list');
                
                if (productInfoElement) {
                    productInfoElement.textContent = product.name;
                }
                if (priceDisplayElement) {
                    priceDisplayElement.textContent = `$${product.price} USD`;
                }
                
                // Populate features list safely
                if (featuresListElement && product.features) {
                    featuresListElement.innerHTML = product.features
                        .map(feature => `<li>${feature}</li>`)
                        .join('');
                }
            } else {
                // Show error message instead of immediate redirect to give user context
                const errorElement = document.getElementById('purchase-error');
                const errorMessageElement = document.getElementById('error-message');
                
                if (errorElement && errorMessageElement) {
                    errorElement.style.display = 'block';
                    errorMessageElement.textContent = 'Invalid product selection. Please select a valid product from the homepage.';
                }
                
                // Redirect after showing error message
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
            }
        });

        // Enhanced global error handling
        window.onerror = function(msg, url, line, col, error) {
            console.error('Global error:', { msg, url, line, col, error });
            
            const errorElement = document.getElementById('purchase-error');
            const errorMessageElement = document.getElementById('error-message');
            
            if (errorElement && errorMessageElement) {
                errorElement.style.display = 'block';
                errorElement.classList.remove('hidden');
                errorMessageElement.textContent = 'An unexpected error occurred. Please refresh the page and try again.';
            }
            
            // Hide loading indicator if shown
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            
            return false;
        };

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            
            const errorElement = document.getElementById('purchase-error');
            const errorMessageElement = document.getElementById('error-message');
            
            if (errorElement && errorMessageElement) {
                errorElement.style.display = 'block';
                errorElement.classList.remove('hidden');
                errorMessageElement.textContent = 'An error occurred during payment processing. Please try again.';
            }
            
            // Hide loading indicator if shown
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            
            // Prevent the default browser handling
            event.preventDefault();
        });
    </script>
</body>
</html>
