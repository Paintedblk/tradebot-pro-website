<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeBotPro - Complete Your Purchase</title>
    
    <!-- Replace CDN with compiled Tailwind -->
    <link href="/dist/output.css" rel="stylesheet">
    
    <style>
        /* Critical CSS */
        .payment-error {
            display: none;
            background-color: #dc2626;
            color: white;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 1rem;
        }
        
        .payment-success {
            display: none;
            background-color: #059669;
            color: white;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 1rem;
        }

        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-4">Complete Your Purchase</h1>
            <div id="product-info" class="text-xl text-gray-300"></div>
            <div id="price-display" class="text-2xl font-bold text-green-500 mt-2"></div>
        </header>

        <main class="max-w-md mx-auto">
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                <div id="loading" class="loading">
                    <div class="spinner mr-3"></div>
                    <span>Processing...</span>
                </div>

                <div id="paypal-button-container"></div>

                <div id="payment-error" class="payment-error">
                    <strong>Error:</strong>
                    <span id="error-message"></span>
                </div>

                <div id="payment-success" class="payment-success">
                    <strong>Success!</strong>
                    <p>Your purchase has been completed. You will receive an email with your license key and download instructions.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AbFAFD99aa0hCnoggRAkKPvSg7i-FBwF1jQvHIqRwIxhgN4nh6fXk_-hxClQj0hCgvbH7m8vT6d2sPHi&currency=USD"></script>
    
    <!-- App Logic -->
    <script>
        // Constants
        const BACKEND_URL = 'https://tradebotpro-backend-553116950013.us-central1.run.app';
        const PRODUCTS = {
            lite: {
                name: 'TradeBotPro Lite Version',
                price: '49.99'
            },
            full: {
                name: 'TradeBotPro Pro Version',
                price: '199.99'
            }
        };

        // State management
        const state = {
            version: null,
            orderID: null,
            loading: false,
            error: null
        };

        // UI Elements
        const elements = {
            productInfo: document.getElementById('product-info'),
            priceDisplay: document.getElementById('price-display'),
            paypalContainer: document.getElementById('paypal-button-container'),
            loading: document.getElementById('loading'),
            error: document.getElementById('payment-error'),
            errorMessage: document.getElementById('error-message'),
            success: document.getElementById('payment-success')
        };

        // Utility functions
        const showError = (message) => {
            elements.error.style.display = 'block';
            elements.errorMessage.textContent = message;
            elements.loading.style.display = 'none';
        };

        const showLoading = () => {
            elements.loading.style.display = 'flex';
            elements.error.style.display = 'none';
            elements.paypalContainer.style.opacity = '0.5';
        };

        const hideLoading = () => {
            elements.loading.style.display = 'none';
            elements.paypalContainer.style.opacity = '1';
        };

        const validateVersion = (version) => {
            return version && PRODUCTS[version];
        };

        // Initialize the page
        const init = () => {
            // Get version from URL
            const urlParams = new URLSearchParams(window.location.search);
            const version = urlParams.get('version');

            if (!validateVersion(version)) {
                showError('Invalid product version. Please return to the product selection page.');
                return false;
            }

            state.version = version;
            const product = PRODUCTS[version];

            // Update UI
            elements.productInfo.textContent = product.name;
            elements.priceDisplay.textContent = `$${product.price} USD`;

            return true;
        };

        // PayPal integration
        const initializePayPal = () => {
            if (!state.version) return;

            const product = PRODUCTS[state.version];

            paypal.Buttons({
                createOrder: async () => {
                    try {
                        showLoading();

                        const response = await fetch(`${BACKEND_URL}/api/create-paypal-order`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                version: state.version,
                                timestamp: Date.now()
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Failed to create order');
                        }

                        const orderData = await response.json();
                        state.orderID = orderData.orderID;
                        return orderData.orderID;
                    } catch (error) {
                        console.error('Order creation failed:', error);
                        showError(error.message);
                        throw error;
                    } finally {
                        hideLoading();
                    }
                },

                onApprove: async (data, actions) => {
                    try {
                        showLoading();

                        const response = await fetch(`${BACKEND_URL}/api/capture-paypal-order`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                orderID: data.orderID,
                                version: state.version
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Failed to capture payment');
                        }

                        const captureData = await response.json();
                        
                        // Store success data
                        sessionStorage.setItem('tradebotpro_purchase_data', JSON.stringify({
                            orderID: data.orderID,
                            version: state.version,
                            licenseKey: captureData.licenseKey,
                            downloadUrl: captureData.downloadUrl
                        }));

                        // Show success and redirect
                        elements.success.style.display = 'block';
                        setTimeout(() => {
                            window.location.href = '/success.html';
                        }, 2000);

                    } catch (error) {
                        console.error('Payment capture failed:', error);
                        showError(error.message);
                    } finally {
                        hideLoading();
                    }
                },

                onCancel: () => {
                    window.location.href = '/cancel.html';
                },

                onError: (err) => {
                    console.error('PayPal error:', err);
                    showError('Payment processing failed. Please try again.');
                }
            }).render('#paypal-button-container')
              .catch(error => {
                  console.error('PayPal button render failed:', error);
                  showError('Failed to initialize payment system. Please refresh the page.');
              });
        };

        // Start the app
        if (init()) {
            initializePayPal();
        }

        // Global error handling
        window.onerror = (msg, url, line, col, error) => {
            console.error('Global error:', { msg, url, line, col, error });
            showError('An unexpected error occurred. Please refresh the page or try again later.');
            return false;
        };
    </script>
</body>
</html>
